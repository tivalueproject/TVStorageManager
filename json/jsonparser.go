package json

import (
	"encoding/json"
	"errors"
	"bytes"
	"reflect"
)

type Json struct {
	data interface{}
}

func JsonParser(body []byte) (*Json, error) {
	j := new(Json)
	err := j.UnmarshalJSON(body)
	if err != nil {
		return nil, err
	}
	return j, nil
}

func (j *Json) Interface() interface{} {
	return j.data
}

func (j *Json) Get(key string) *Json {
	m, err := j.Map()
	if err == nil {
		if val, ok := m[key]; ok {
			return &Json{val}
		}
	}
	return &Json{nil}
}

func (j *Json) GetIndex(index int) *Json {
	a, err := j.Array()
	if err == nil {
		if len(a) > index {
			return &Json{a[index]}
		}
	}
	return &Json{nil}
}

func (j *Json) Map() (map[string]interface{}, error) {
	if m, ok := (j.data).(map[string]interface{}); ok {
		return m, nil
	}
	return nil, errors.New("type assertion to map[string]interface{} failed")
}

func (j *Json) Array() ([]interface{}, error) {
	if a, ok := (j.data).([]interface{}); ok {
		return a, nil
	}
	return nil, errors.New("type assertion to []interface{} failed")
}

func (j *Json) Bool() (bool, error) {
	if s, ok := (j.data).(bool); ok {
		return s, nil
	}
	return false, errors.New("type assertion to bool failed")
}

func (j *Json) String() (string, error) {
	if s, ok := (j.data).(string); ok {
		return s, nil
	}
	return "", errors.New("type assertion to string failed")
}

func (j *Json) UnmarshalJSON(p []byte) error {
	dec := json.NewDecoder(bytes.NewBuffer(p))
	dec.UseNumber()
	return dec.Decode(&j.data)
}

func (j *Json) Int() (int, error) {
	switch j.data.(type) {
	case json.Number:
		i, err := j.data.(json.Number).Int64()
		return int(i), err
	case float32, float64:
		return int(reflect.ValueOf(j.data).Float()), nil
	case int, int8, int16, int32, int64:
		return int(reflect.ValueOf(j.data).Int()), nil
	case uint, uint8, uint16, uint32, uint64:
		return int(reflect.ValueOf(j.data).Uint()), nil
	}
	return 0, errors.New("invalid value type")
}

func GenerateJsonString(method string, params interface{}) string {
	var s = make(map[string]interface{})
	s["jsonrpc"] = "2.0"
	s["id"] = 1
	s["method"] = method
	s["params"] = params
	result, _ := json.Marshal(s)
	return string(result)
}

func GenerateJsonRpcString(id string, method string, params interface{}) string {
	var s = make(map[string]interface{})
	s["jsonrpc"] = "2.0"
	s["id"] = id
	s["method"] = method
	s["params"] = params
	result, _ := json.Marshal(s)
	return string(result)
}

func GenerateJsonRpcResult(id string, result interface{}) string {
	var s = make(map[string]interface{})
	s["id"] = id
	s["result"] = result
	resultBytes, _ := json.Marshal(s)
	return string(resultBytes)
}